{% extends 'base.html' %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <h2 class="fw-bold text-dark m-0"><i class="fas fa-history text-primary me-2"></i> سجل الحركة اليومية</h2>
    <div class="btn-group shadow-sm w-100 w-md-auto">
        <button onclick="window.print()" class="btn btn-outline-secondary bg-white flex-fill">
            <i class="fas fa-print me-1"></i> طباعة
        </button>
        <a href="/admin/store/dailytransaction/add/" class="btn btn-primary flex-fill">
            <i class="fas fa-plus me-1"></i> إضافة حركة
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body py-3">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
                <label class="small text-muted mb-2 fw-bold"><i class="fas fa-filter me-1"></i> عرض حركة فترة:</label>
                <select name="period" class="form-select border-0 bg-light rounded-3" onchange="this.form.submit()">
                    <option value="all" {% if request.GET.period == 'all' %}selected{% endif %}>طوال الوقت</option>
                    <option value="today" {% if request.GET.period == 'today' %}selected{% endif %}>حركة اليوم</option>
                    <option value="week" {% if request.GET.period == 'week' %}selected{% endif %}>آخر أسبوع</option>
                    <option value="month" {% if request.GET.period == 'month' %}selected{% endif %}>آخر شهر</option>
                    <option value="custom" {% if request.GET.period == 'custom' %}selected{% endif %}>تاريخ محدد...</option>
                </select>
            </div>
            
            {% if request.GET.period == 'custom' %}
            <div class="col-6 col-md-3">
                <label class="small text-muted mb-2 fw-bold">من تاريخ:</label>
                <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control border-0 bg-light rounded-3">
            </div>
            <div class="col-6 col-md-3">
                <label class="small text-muted mb-2 fw-bold">إلى تاريخ:</label>
                <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control border-0 bg-light rounded-3">
            </div>
            <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-dark w-100 rounded-3">تطبيق</button>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<div class="card border-0 shadow-sm overflow-hidden rounded-4">
    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
        <h5 class="m-0 fw-bold text-dark fs-6 fs-md-5">كشف الوارد والصادر والمستحقات</h5>
        <span class="badge bg-primary rounded-pill">العدد: {{ transactions|length }}</span>
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle m-0">
                <thead class="bg-primary text-white text-center">
                    <tr>
                        <th class="py-3 border-0 text-nowrap">التاريخ</th>
                        <th class="py-3 border-0 text-nowrap">الحركة</th>
                        <th class="py-3 border-0 text-nowrap">الصنف</th>
                        <th class="py-3 border-0 text-nowrap">التاجر</th>
                        <th class="py-3 border-0 text-nowrap">الوزن</th>
                        <th class="py-3 border-0 text-nowrap">الإجمالي</th>
                        <th class="py-3 border-0 text-nowrap">المدفوع</th>
                        <th class="py-3 border-0 text-nowrap text-warning">المتبقي</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    {% for t in transactions %}
                    <tr class="{% if t.transaction_type == 'in' %}table-light-blue{% else %}table-light-orange{% endif %}">
                        <td class="text-nowrap small fw-bold text-muted">{{ t.date|date:"Y-m-d" }}</td>
                        <td class="text-nowrap">
                            {% if t.transaction_type == 'in' %}
                                <span class="badge rounded-pill px-3 py-2 bg-info-subtle text-info border border-info-subtle">
                                    <i class="fas fa-arrow-down me-1"></i> وارد
                                </span>
                            {% else %}
                                <span class="badge rounded-pill px-3 py-2 bg-warning-subtle text-warning-emphasis border border-warning-subtle">
                                    <i class="fas fa-arrow-up me-1"></i> صادر
                                </span>
                            {% endif %}
                        </td>
                        <td class="fw-bold text-nowrap">{{ t.product.name }}</td>
                        <td class="text-nowrap">
                            <span class="text-dark small"><i class="far fa-user me-1"></i> {{ t.contact.name|truncatechars:15 }}</span>
                        </td>
                        <td class="text-nowrap">
                            <span class="fw-medium">{{ t.weight }} <small>كجم</small></span>
                        </td>
                        <td class="fw-bold text-nowrap">{{ t.total_price }} <small>ج.م</small></td>
                        
                        <td class="text-success text-nowrap">
                            {{ t.financialrecord.amount_paid|default:"0.00" }}
                        </td>

                        <td class="text-nowrap">
                            {% if t.financialrecord.remaining_amount > 0 %}
                                <span class="text-danger fw-bold">{{ t.financialrecord.remaining_amount }} <small>ج.م</small></span>
                            {% else %}
                                <span class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1">
                                    <i class="fas fa-check-circle"></i> خالص
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="py-5 text-muted">
                            <div class="text-center">
                                <i class="fas fa-folder-open fa-3x mb-3 opacity-25"></i>
                                <p>لا توجد بيانات متاحة حالياً</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* تحسينات الاستجابة للأجهزة المحمولة */
    .table-responsive {
        -webkit-overflow-scrolling: touch;
    }

    /* ألوان مخصصة للصفوف */
    .table-light-blue { background-color: #f8fbff !important; }
    .table-light-orange { background-color: #fffaf4 !important; }

    /* تأثير تمرير الماوس */
    .table-hover tbody tr:hover {
        background-color: #f1f3f5 !important;
        transition: 0.3s;
    }

    /* تنسيقات الخطوط للشاشات الصغيرة */
    @media (max-width: 768px) {
        .table td, .table th {
            padding: 0.75rem 0.5rem;
            font-size: 0.85rem;
        }
        .badge { font-size: 0.7rem; }
    }

    /* تحسين الطباعة */
    @media print {
        @page { size: landscape; margin: 0.5cm; }
        .navbar, .btn-group, form, .badge.bg-primary { display: none !important; }
        .card { border: 1px solid #ddd !important; box-shadow: none !important; }
        .table-responsive { overflow: visible !important; }
        th { background-color: #0d6efd !important; color: white !important; -webkit-print-color-adjust: exact; }
    }
</style>
{% endblock %}