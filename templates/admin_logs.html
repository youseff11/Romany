{% extends 'base.html' %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="admin-logs-container py-3 py-md-5">
    
    <div class="container-fluid mb-4 no-print">
        <div class="row align-items-center bg-white p-3 p-md-4 rounded-4 shadow-sm border-0 border-start border-primary border-5 mx-1">
            <div class="col-md-7 text-center text-md-start">
                <h2 class="fw-800 text-dark mb-1 fs-3 fs-md-2">
                    <span class="text-primary"><i class="fas fa-chart-pie me-2"></i></span> التقرير المالي الشامل
                </h2>
                <p class="text-muted mb-0 d-none d-md-block small">تحليل لحظي لتدفقات السيولة، المخزون، والديون القائمة وصافي قيمة العمل.</p>
            </div>
            <div class="col-md-5 text-center text-md-end mt-3 mt-md-0">
                <button onclick="window.print()" class="btn btn-outline-dark rounded-pill px-3 px-md-4 me-1 mb-2 mb-md-0">
                    <i class="fas fa-print me-2"></i>PDF
                </button>
                <div class="date-badge d-inline-block p-2 rounded-pill bg-light border shadow-sm small">
                    <i class="far fa-calendar-check me-1 text-primary"></i> {{ today|date:"l، d F Y" }}
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mb-4 no-print">
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-body bg-white p-3">
                <form method="GET" action="" id="filterForm" class="row g-2 g-md-3 align-items-end">
                    <div class="col-6 col-md-3">
                        <label class="form-label small fw-bold text-muted">من تاريخ</label>
                        <input type="date" name="start_date" class="form-control rounded-pill border-light bg-light shadow-none small" value="{{ start_date }}">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label small fw-bold text-muted">إلى تاريخ</label>
                        <input type="date" name="end_date" class="form-control rounded-pill border-light bg-light shadow-none small" value="{{ end_date }}">
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="btn-group w-100 rounded-pill overflow-hidden shadow-sm" role="group">
                            <button type="submit" name="period" value="today" class="btn btn-filter btn-outline-primary btn-sm py-2 {% if period == 'today' %}active{% endif %}">اليوم</button>
                            <button type="submit" name="period" value="week" class="btn btn-filter btn-outline-primary btn-sm py-2 {% if period == 'week' %}active{% endif %}">أسبوع</button>
                            <button type="submit" name="period" value="month" class="btn btn-filter btn-outline-primary btn-sm py-2 {% if period == 'month' %}active{% endif %}">شهر</button>
                            <button type="submit" name="period" value="all" class="btn btn-filter btn-outline-primary btn-sm py-2 {% if period == 'all' or not period %}active{% endif %}">الكل</button>
                        </div>
                    </div>
                    <div class="col-12 col-md-2">
                        <button type="submit" class="btn btn-dark w-100 rounded-pill py-2 shadow-sm fw-bold">
                            <i class="fas fa-filter me-1"></i> تصفية
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container-fluid mb-4">
        <div class="row g-2 g-md-4">
            <div class="col-6 col-md-4 col-xl-2">
                <div class="f-card f-card-cash shadow-sm h-100">
                    <div class="f-card-icon"><i class="fas fa-vault"></i></div>
                    <div class="f-card-label">الخزنة (كاش)</div>
                    <div class="f-card-value">{{ cash_in_hand|floatformat:0 }}<small>ج.م</small></div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
                <div class="f-card f-card-inventory shadow-sm h-100">
                    <div class="f-card-icon text-white"><i class="fas fa-boxes-stacked"></i></div>
                    <div class="f-card-label">قيمة البضاعة</div>
                    <div class="f-card-value text-white">{{ total_inventory_value|floatformat:0 }}<small>ج.م</small></div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
                <div class="f-card f-card-receivable shadow-sm h-100">
                    <div class="f-card-icon"><i class="fas fa-arrow-down-long"></i></div>
                    <div class="f-card-label">لينا عند الغير</div>
                    <div class="f-card-value">{{ receivable|floatformat:0 }}<small>ج.م</small></div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
                <div class="f-card f-card-payable shadow-sm h-100">
                    <div class="f-card-icon"><i class="fas fa-arrow-up-long"></i></div>
                    <div class="f-card-label">علينا للتجار</div>
                    <div class="f-card-value">{{ payable|floatformat:0 }}<small>ج.م</small></div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
                <div class="f-card f-card-bank shadow-sm h-100">
                    <div class="f-card-icon"><i class="fas fa-university"></i></div>
                    <div class="f-card-label">متبقي البنك</div>
                    <div class="f-card-value">{{ bank_remaining|floatformat:0 }}<small>ج.م</small></div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
                <div class="f-card f-card-profit shadow-sm h-100 border-bottom border-success border-5">
                    <div class="f-card-icon text-success"><i class="fas fa-hand-holding-dollar"></i></div>
                    <div class="f-card-label">أرباح الفترة</div>
                    <div class="f-card-value text-success">{{ total_profit_period|floatformat:0 }}<small>ج.م</small></div>
                </div>
            </div>
            <div class="col-12 mt-2">
                <div class="f-card f-card-expense shadow-sm border-danger border-bottom border-5 flex-row justify-content-around py-3">
                    <div class="d-flex align-items-center">
                        <div class="f-card-icon text-danger mb-0 me-3"><i class="fas fa-house-user"></i></div>
                        <div class="text-start">
                            <div class="f-card-label mb-0">إجمالي مصروف البيت</div>
                            <div class="f-card-value text-danger">{{ total_home_expenses|floatformat:0 }}<small>ج.م</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mb-5">
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-header bg-white py-3 px-4 d-flex flex-column flex-md-row justify-content-between align-items-center border-0">
                <h5 class="mb-3 mb-md-0 fw-bold text-dark fs-5">
                    <i class="fas fa-receipt text-primary me-2"></i>سجل الوارد (المشتريات)
                </h5>
                <a href="/admin/store/dailytransaction/add/" class="btn btn-primary-gradient rounded-pill px-4 shadow-sm no-print w-100 w-md-auto">
                    <i class="fas fa-plus-circle me-2"></i>إضافة فاتورة
                </a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 custom-table text-center small-text-mobile">
                    <thead>
                        <tr>
                            <th class="ps-4">التاريخ</th>
                            <th>التاجر</th>
                            <th>المنتج</th>
                            <th class="d-none d-md-table-cell">الوزن</th>
                            <th class="d-none d-md-table-cell">السعر</th>
                            <th class="pe-4">المدفوع/الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in purchase_logs %}
                        <tr>
                            <td class="ps-4">
                                <div class="date-cell mx-auto">
                                    <span class="day">{{ log.date|date:"d" }}</span>
                                    <span class="month">{{ log.date|date:"M" }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-dark small">{{ log.contact.name }}</div>
                            </td>
                            <td><span class="product-badge">{{ log.product.name }}</span></td>
                            <td class="d-none d-md-table-cell"><span class="fw-600">{{ log.weight }}</span> <small class="text-muted">كجم</small></td>
                            <td class="d-none d-md-table-cell"><span class="text-secondary fw-bold">{{ log.price_per_kg }}</span></td>
                            <td class="pe-4">
                                <div class="total-price-tag mx-auto">
                                    <span class="text-white fw-bold">{{ log.paid_amount|floatformat:0 }}</span>
                                    <span class="small" style="font-size: 0.7em;">/ {{ log.total_price|floatformat:0 }}</span>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="py-4 text-muted">لا توجد عمليات</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container-fluid mb-5">
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-header bg-white py-3 px-4 border-0">
                <h5 class="mb-0 fw-bold text-dark fs-5">
                    <i class="fas fa-chart-line text-success me-2"></i>تحليل الأرباح (المبيعات)
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 custom-table text-center small-text-mobile">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">التاريخ</th>
                            <th>المنتج</th>
                            <th>العميل</th>
                            <th class="d-none d-md-table-cell">الوزن</th>
                            <th class="d-none d-md-table-cell">إجمالي المبلغ</th>
                            <th class="d-none d-md-table-cell">المدفوع</th>
                            <th class="pe-4">صافي الربح</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in profit_logs %}
                        <tr>
                            <td class="ps-4">{{ log.date|date:"d/m" }}</td>
                            <td><span class="product-badge bg-info-light">{{ log.product.name }}</span></td>
                            <td><div class="small">{{ log.contact.name }}</div></td>
                            <td class="d-none d-md-table-cell"><span class="fw-600">{{ log.weight }}</span> <small class="text-muted">كجم</small></td>
                            <td class="d-none d-md-table-cell text-muted fw-bold">{{ log.total_price|floatformat:0 }}</td>
                            <td class="d-none d-md-table-cell text-success fw-bold">{{ log.paid_amount|floatformat:0 }}</td>
                            <td class="pe-4">
                                <span class="badge bg-success px-2 py-2 rounded-pill shadow-sm small">
                                    +{{ log.unit_profit|floatformat:0 }}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="7" class="py-4 text-muted">لا توجد بيانات</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container-fluid mb-5">
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden border-top border-danger border-5">
            <div class="card-header bg-white py-3 px-4 d-flex flex-column flex-md-row justify-content-between align-items-center border-0">
                <h5 class="mb-3 mb-md-0 fw-bold text-dark fs-5">
                    <i class="fas fa-wallet text-danger me-2"></i>سجل مصروف البيت
                </h5>
                <a href="/admin/store/homeexpense/add/" class="btn btn-danger rounded-pill px-4 shadow-sm no-print w-100 w-md-auto small">
                    <i class="fas fa-plus me-2"></i>إضافة مصروف
                </a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 custom-table text-center small-text-mobile">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">التاريخ</th>
                            <th>البيان</th>
                            <th class="pe-4">المبلغ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in home_expenses %}
                        <tr>
                            <td class="ps-4 small">{{ expense.date|date:"d/m/Y" }}</td>
                            <td class="fw-600 small">{{ expense.description }}</td>
                            <td class="pe-4 text-danger fw-bold">{{ expense.amount|floatformat:0 }} <small>ج</small></td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="py-4 text-muted">لا توجد مصاريف</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container-fluid mb-5">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-xl-6">
                <div class="f-card f-card-net shadow-lg text-center p-4">
                    <div class="f-card-icon mx-auto"><i class="fas fa-gem"></i></div>
                    <div class="f-card-label">إجمالي قيمة العمل (الصافي)</div>
                    <div class="f-card-value text-white fs-2">{{ total_capital|floatformat:0 }}<small>ج.م</small></div>
                    <p class="small mt-2 opacity-75 mb-0 d-none d-md-block">المعادلة: (خزنة + بضاعة + لينا) - (علينا + بنك + مصروفات)</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        --success-gradient: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
        --bg-body: #f8f9fc;
    }

    body { font-family: 'Cairo', sans-serif; background-color: var(--bg-body); color: #6a664e; }
    
    .btn-filter.active {
        background-color: #4e73df !important;
        color: white !important;
        border-color: #4e73df !important;
    }

    .f-card {
        padding: 15px; border-radius: 15px; background: #fff;
        position: relative; overflow: hidden; transition: all 0.3s ease;
        border: none; display: flex; flex-direction: column; align-items: center; text-align: center;
    }
    
    .f-card-icon {
        width: 40px; height: 40px; background: rgba(0,0,0,0.05); border-radius: 12px;
        display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 10px;
    }
    
    .f-card-label { font-size: 0.75rem; font-weight: 700; color: #a7aac3; margin-bottom: 3px; }
    .f-card-value { font-size: 1.25rem; font-weight: 800; }
    
    @media (min-width: 768px) {
        .f-card { padding: 25px 20px; border-radius: 20px; }
        .f-card-icon { width: 50px; height: 50px; font-size: 1.5rem; }
        .f-card-label { font-size: 0.85rem; }
        .f-card-value { font-size: 1.6rem; }
    }

    .f-card-cash { border-bottom: 5px solid #f6c23e; } .f-card-cash i { color: #f6c23e; }
    .f-card-inventory { background: var(--success-gradient); color: #fff; }
    .f-card-receivable { border-bottom: 5px solid #36b9cc; } .f-card-receivable i { color: #36b9cc; }
    .f-card-payable { border-bottom: 5px solid #e74a3b; } .f-card-payable i { color: #e74a3b; }
    .f-card-bank { border-bottom: 5px solid #858796; } .f-card-bank i { color: #858796; }
    .f-card-net { background: var(--primary-gradient); color: #fff; border-radius: 25px !important; }

    .product-badge { background: #f0f2f9; padding: 3px 8px; border-radius: 6px; font-weight: 600; font-size: 0.8rem; display: inline-block; }
    .bg-info-light { background-color: #e3f2fd; }

    .custom-table thead th { background-color: #f8f9fc; color: #4e73df; font-weight: 700; border: none; font-size: 0.85rem; padding: 12px; }
    .date-cell { width: 45px; background: #f8f9fc; border-radius: 8px; padding: 3px; border: 1px solid #e3e6f0; }
    .date-cell .day { display: block; font-weight: 800; font-size: 1rem; line-height: 1; color: #224abe; }
    .date-cell .month { font-size: 0.65rem; text-transform: uppercase; color: #858796; }

    .total-price-tag { background: #1cc88a; color: #fff; padding: 5px 10px; border-radius: 8px; width: fit-content; font-size: 0.85rem; }
    .btn-primary-gradient { background: var(--primary-gradient); color: #fff; border: none; }

    @media (max-width: 576px) {
        .small-text-mobile { font-size: 0.75rem !important; }
        .container-fluid { padding-left: 10px; padding-right: 10px; }
        .f-card-value { font-size: 1.1rem; }
    }

    @media print {
        .no-print { display: none !important; }
        body { background-color: white !important; }
        .f-card-inventory, .f-card-net { background: #f8f9fc !important; color: black !important; border: 1px solid #ddd; }
        .f-card-inventory *, .f-card-net * { color: black !important; }
    }
</style>

<script>
    document.querySelectorAll('.btn-filter').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
        });
    });
</script>
{% endblock %}